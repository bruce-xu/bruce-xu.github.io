---
layout: post
title:  å›¾ç‰‡ç€‘å¸ƒæµå±•ç°çš„å®ç°
date:   2016-04-02 12:15:10 +0800
categories: [JS, Waterfall]
permalink: blogs/js/waterfall
tags: Waterfall
keywords: JS,Waterfall,ç€‘å¸ƒæµ
---

ã€€ã€€ä¸Šä¸€ç¯‡ç»“å°¾å¤„è¯´å†æ¥å†å‰ï¼Œå¸Œæœ›èƒ½å¤šå†™ç‚¹ä¸œè¥¿ã€‚åŠä¸ªå¤šæœˆè¿‡å»äº†ï¼Œè¿˜æ²¡æœ‰åŠ¨é™ã€‚æœç„¶ç”·äººçš„è¯æ˜¯ä¸å¯ä¿¡çš„ğŸ˜“ ã€‚ä¸ºäº†æŒ½å›ä¸€ç‚¹ä»…æœ‰çš„ä¿¡ç”¨ï¼Œè¿˜æ˜¯èµ¶å¿«å†™ç‚¹ä¸œè¥¿å§ã€‚

ã€€ã€€ç°åœ¨æœ‰äº›æœ‰è¾ƒå¤šå›¾ç‰‡å±•ç¤ºçš„ç½‘ç«™ä¼šé€‰æ‹©ä½¿ç”¨ç€‘å¸ƒæµçš„æ–¹å¼å®ç°ã€‚ä¸Šå‘¨éšæ‰‹å†™äº†ä¸€ä¸ªJSè„šæœ¬æ¥å®ç°æ­¤åŠŸèƒ½ï¼Œä¸‹é¢ä»‹ç»å®ç°è¿‡ç¨‹ã€‚

ã€€ã€€é¦–å…ˆè¯´æ˜ä¸€ä¸‹ç€‘å¸ƒæµå±•ç¤ºçš„ç‰¹ç‚¹ï¼šå›¾ç‰‡å®šå®½ä¸å®šé«˜ï¼ˆå½“ç„¶ä¸ªåˆ«æƒ…å†µå®½é«˜éƒ½ä¸å®šï¼Œä¸è¿‡è¿™ç§æƒ…å†µä¸åœ¨æˆ‘ä»¬è®¨è®ºçš„èŒƒå›´å†…ï¼‰ï¼›ä¸‹ä¸€å¼ å›¾ç‰‡ä¼šè¢«æ”¾ç½®åˆ°å½“å‰é«˜åº¦æœ€å°çš„ä¸€åˆ—ã€‚åŸºäºä¸Šè¿°çš„ä¸¤ä¸ªç‰¹ç‚¹ï¼Œè¯¥å¦‚ä½•å¸ƒå±€å‘¢ï¼Ÿé¦–å…ˆæƒ³åˆ°çš„æ˜¯æµ®åŠ¨å¸ƒå±€ï¼Œä½†æ— è®ºæ˜¯å‘å·¦æµ®åŠ¨è¿˜æ˜¯å‘å³æµ®åŠ¨ï¼Œéƒ½ä¼šå¦‚ä¸‹é¢æˆªå›¾ä¸­çš„å¸ƒå±€ä¸€æ ·ï¼Œæ— æ³•æ»¡è¶³è¦æ±‚ï¼š

> å‘å·¦æµ®åŠ¨
![float: left](/assets/waterfall/float-left.jpg)

> å‘å³æµ®åŠ¨
![float: left](/assets/waterfall/float-right.jpg)

ã€€ã€€æ—¢ç„¶ `float` æ— æ³•æ»¡è¶³ï¼Œåªèƒ½æ¢å…¶å®ƒæ€è·¯äº†ã€‚æ­£å¸¸çš„æ–‡æ¡£æµå®ç°ä¸äº†è¿™ç§è·³è·ƒå¼çš„å¸ƒå±€ï¼Œçœ‹æ¥åªèƒ½è·³å‡ºæ–‡æ¡£æµä¹‹å¤–äº†ã€‚ç”±æ­¤å¯ä»¥æƒ³åˆ°ä½¿ç”¨ `position: absolute` æ¥å¸ƒå±€ã€‚å¸ƒå±€æŸå¼ å›¾ç‰‡æ—¶ï¼ŒåŠ¨æ€è®¡ç®—å½“å‰é«˜åº¦æœ€ä½çš„åˆ—ï¼Œç„¶åé€šè¿‡è®¾ç½®å›¾ç‰‡å®¹å™¨çš„ `left` å€¼æ¥æ”¾ç½®å›¾ç‰‡åˆ°é‚£ä¸€åˆ—ï¼Œå†é€šè¿‡è®¾ç½® `top` å€¼æ¥è®¾ç½®å›¾ç‰‡çš„å‚ç›´ä½ç½®ï¼Œæœ€åæ›´æ–°è¿™ä¸€åˆ—çš„é«˜åº¦ã€‚

å…·ä½“å®ç°ä¸Šï¼Œå®šä¹‰äº†ä¸€ä¸ªå« `Waterfall` çš„æ„é€ å‡½æ•°ï¼Œéœ€è¦ä¼ é€’å¦‚ä¸‹çš„é…ç½®å‚æ•°ï¼š

{% highlight js %}
container: null  //ï¼ˆrequiredï¼‰åŒ…å«ç€‘å¸ƒæµå›¾ç‰‡çš„DOMå®¹å™¨å…ƒç´ 
itemWidth: 0     //ï¼ˆoptionalï¼‰æ¯ä¸€å¼ å›¾ç‰‡å¤–å±‚DOMå…ƒç´ çš„ç›’æ¨¡å‹å®½åº¦
itemClass: ''    //ï¼ˆoptionalï¼‰æ¯ä¸€å¼ å›¾ç‰‡å¤–å±‚DOMå…ƒç´ çš„classåï¼Œä¸ä¼ çš„è¯ä¼šå–`container`çš„ç›´æ¥å­èŠ‚ç‚¹
middle: true     //ï¼ˆoptionalï¼‰æ˜¯å¦å±…ä¸­æ˜¾ç¤ºç€‘å¸ƒæµå†…å®¹
animation: true  //ï¼ˆoptionalï¼‰å›¾ç‰‡åŠ è½½å®Œå±•ç°æ—¶æ˜¯å¦æœ‰åŠ¨ç”»æ•ˆæœ
duration: 1      //ï¼ˆoptionalï¼‰åŠ¨ç”»æ—¶é•¿ï¼ˆå•ä½ï¼šç§’ï¼‰
{% endhighlight %}

ã€€ã€€å…¶ä¸­ `container` å‚æ•°æ˜¯ç€‘å¸ƒæµçš„çˆ¶å®¹å™¨èŠ‚ç‚¹ï¼Œä¸ºå¿…é¡»å‚æ•°ï¼Œå…¶å®ƒå‚æ•°å¯é€‰ã€‚å°†ä¼ é€’çš„å‚æ•° extend ï¼ˆå†…éƒ¨æœ‰å®ç° `extend` æ–¹æ³•ã€‚ç”±äºæ˜¯åŸç”ŸJSå®ç°ï¼Œæœªä½¿ç”¨jQueryç­‰å·¥å…·åº“ï¼Œæ‰€ä»¥ä¸€äº›å·¥å…·å‡½æ•°éœ€è¦æ‰‹åŠ¨å®ç°ï¼‰åˆ°è¿è¡Œæ—¶çš„ `this` å¯¹è±¡ï¼ˆå³ `Waterfall` å¯¹è±¡ï¼‰ä¸Šåï¼Œè°ƒç”¨ `init` ï¼ˆå†…éƒ¨ç§æœ‰å‡½æ•°ï¼Œå¯¹äºä¸éœ€è¦ç”¨æˆ·è°ƒç”¨çš„æ–¹æ³•ï¼Œæˆ‘ä¸€èˆ¬ä¹ æƒ¯å°è£…æˆç§æœ‰å‡½æ•°ï¼‰æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚æœ€åè°ƒç”¨ `render` ï¼ˆæ­¤ç€‘å¸ƒæµå®ç°ä¸­åªéœ€æš´éœ²äº†ä¸€ä¸ª `render` æ–¹æ³•ç»™ç”¨æˆ·ï¼‰æ–¹æ³•æ¸²æŸ“å‡ºç€‘å¸ƒæµå¸ƒå±€ã€‚

ã€€ã€€ä¸Šé¢æåˆ°çš„ `init` åˆå§‹åŒ–å‡½æ•°åšäº†ä¸‰ä»¶äº‹ï¼šè·å–å›¾ç‰‡å®¹å™¨ï¼ˆè¿™é‡Œå‡å®šæ¯å¼ å›¾ç‰‡çš„å¤–å±‚éƒ½ä¼šæœ‰å®¹å™¨å…ƒç´ åŒ…è£¹ï¼Œè€Œä¸æ˜¯å…‰ç§ƒç§ƒçš„å›¾ç‰‡å¹¶æ’æ’åˆ—ï¼Œä¸”æ¯ä¸ªå›¾ç‰‡å®¹å™¨çš„å®½åº¦ç›¸åŒã€‚å¦‚æœæ²¡æœ‰åŒ…è£¹æˆ–å®½åº¦ä¸ç­‰ï¼Œåªèƒ½å‘µå‘µäº†ï¼‰çš„ç›’æ¨¡å‹çš„å¤§å°ï¼›è®¡ç®—æ€»å…±æœ‰å¤šå°‘åˆ—ï¼›ç”±äºç”¨åˆ° `position: absolute` å¸ƒå±€ï¼Œæ‰€ä»¥éœ€è¦ç»™ç€‘å¸ƒæµå®¹å™¨ `container` è®¾ç½® `position: relative` CSS å±æ€§ã€‚

ã€€ã€€ä¸Šé¢è¯´åˆ°çš„è®¡ç®—å›¾ç‰‡å®¹å™¨ç›’æ¨¡å‹çš„å¤§å°éœ€è¦å±•å¼€è¯´æ˜ä¸€ä¸‹ã€‚æ„é€ å‡½æ•° `Waterfall` çš„å‚æ•°ä¸­æœ‰ä¸€ä¸ª `itemWidth` çš„å‚æ•°ï¼Œä»£è¡¨äº†å›¾ç‰‡å®¹å™¨å…ƒç´ çš„å®½åº¦ï¼ˆæ­¤å¤„çš„å®½åº¦ï¼Œæˆ‘æŠŠå®ƒå½“åšæ˜¯å…ƒç´ ç›’æ¨¡å‹çš„æ€»å®½åº¦ï¼Œå³ `width + padding + border`ï¼Œè€Œéå…ƒç´ å†…å®¹çš„å®½åº¦ `width` ï¼Œæ­¤å¤„ï¼Œæˆ‘è§‰å¾—è¿™æ ·æ›´åˆç†ï¼Œä¹Ÿæ–¹ä¾¿è°ƒç”¨è€…å¤„ç†ï¼‰ï¼Œå¦‚æœæœ‰å°±ä½¿ç”¨æ­¤å€¼ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è·å–ç¬¬ä¸€ä¸ªå›¾ç‰‡å®¹å™¨çš„ `width + padding + border` ä½œä¸º `itemWidth`ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦è¯´æ˜ï¼Œå¦‚æœå›¾ç‰‡å®¹å™¨æœ‰è®¾ç½® CSS å±æ€§ `box-sizing: border-box`ï¼Œåˆ™å…¶ `width` å°±å·²ç»æ˜¯å†…å®¹å®½åº¦ã€`padding` ä»¥åŠ `margin` ä¹‹å’Œäº†ï¼Œæ‰€ä»¥å°±ä¸ç”¨å†ç›¸åŠ äº†ã€‚

ã€€ã€€åœ¨è°ƒç”¨ `render` æ–¹æ³•æ¸²æŸ“ç€‘å¸ƒæµå¸ƒå±€æ—¶ï¼Œæœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼šå›¾ç‰‡æ˜¯éœ€è¦é€šè¿‡ç½‘ç»œåŠ è½½çš„ï¼Œå› æ­¤æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“è¿è¡Œ `render` æ–¹æ³•æ—¶ï¼Œå›¾ç‰‡åº”è¯¥è¿˜æ²¡æœ‰åŠ è½½å®Œï¼ˆå¦‚æœæ˜¯è¯»ç¼“å­˜çš„è¯ï¼Œå¯èƒ½æ­¤æ—¶å·²ç»åŠ è½½å®Œäº†ã€‚å½“ç„¶å¦‚æœæ˜¯åœ¨ `window.onload` äº‹ä»¶å¤„ç†ä¸­è°ƒç”¨çš„ `Waterfall` æ„é€ å‡½æ•°ï¼Œåˆ™æ­¤æ—¶å›¾ç‰‡éƒ½å·²ç»åŠ è½½å®Œæˆäº†ã€‚ä½†è¿™æ ·çš„è¯ï¼Œä¸€æ˜¯å¦‚æœæœ‰å¤§é‡å›¾ç‰‡çš„è¯ï¼Œä¼šç­‰å¾ˆä¹…æ‰ä¼šæ¸²æŸ“å‡ºç€‘å¸ƒæµæ•ˆæœï¼ŒäºŒæ˜¯å¦‚æœæœ‰åˆ†é¡µå¼‚æ­¥åŠ è½½çš„æƒ…å†µï¼Œä¾ç„¶ä¼šæœ‰æ­¤é—®é¢˜ã€‚ï¼‰ï¼Œæ‰€ä»¥éœ€è¦é’ˆå¯¹å›¾ç‰‡çš„åŠ è½½åšå¤„ç†ã€‚æ­¤å¤„é¦–å…ˆæŸ¥æ‰¾å‡ºæ‰€æœ‰çš„å›¾ç‰‡ï¼Œç„¶åéå†æ¯å¼ å›¾ç‰‡ï¼Œåˆ¤æ–­å›¾ç‰‡æ˜¯å¦åŠ è½½å®Œæˆï¼ˆimg å…ƒç´ ä¼šæœ‰ä¸€ä¸ª `complete` å±æ€§ï¼Œå¦‚æœå·²ç»åŠ è½½å®Œæˆï¼Œåˆ™æ­¤å±æ€§ä¸º trueï¼Œå¦åˆ™ä¸º falseï¼‰ã€‚å¦‚æœå·²åŠ è½½å®Œæˆï¼Œåˆ™ç›´æ¥è®¡ç®—å¸ƒå±€æ¸²æŸ“å‡ºæ¥ï¼Œå¦åˆ™çš„è¯ï¼Œç»™å›¾ç‰‡æ·»åŠ  `onload` äº‹ä»¶ï¼Œ`onload` äº‹ä»¶è§¦å‘åå†è®¡ç®—å¸ƒå±€æ¸²æŸ“ã€‚

ã€€ã€€è¿˜æœ‰å‡ ä¸ªç»†èŠ‚éœ€è¦æä¸€ä¸‹ã€‚æ¸²æŸ“å›¾ç‰‡æ—¶ï¼Œç”±äºéœ€è¦è®¾ç½®å‡ ä¸ªæ ·å¼å±æ€§ï¼Œä¸ºäº†å‡å°‘å¯èƒ½çš„ `reflow/repaint` ï¼Œå°†å¤šä¸ªæ ·å¼å±æ€§ç»„åˆèµ·æ¥ï¼Œä¸€æ¬¡èµ‹å€¼ç»™ `style.cssText` ï¼›å›¾ç‰‡æ¸²æŸ“æ—¶é»˜è®¤æ·»åŠ äº†åŠ¨ç”»æ•ˆæœï¼Œå¼€å§‹æ˜¯å‡†å¤‡å…ˆ `display: none` éšè—å›¾ç‰‡ï¼Œå¹¶è®¾ç½® `transition: display 1s` çš„ CSS å±æ€§æ¥è®¾ç½®åŠ¨ç”»æ•ˆæœï¼Œå¾…åŠ è½½å®Œæˆåé€šè¿‡ `display: block` åŠ¨ç”»æ•ˆæœæ˜¾ç¤ºå‡ºæ¥ã€‚ä½†æ˜¯æœ€åå‘ç° `display` å±æ€§ä¸æ”¯æŒåŠ¨ç”»æ•ˆæœï¼ŒåŒ…æ‹¬ä½¿ç”¨å…¶å®ƒå±æ€§å’Œå®ƒç»„åˆåŠ¨ç”»ä¹Ÿä¸è¡Œã€‚äºæ˜¯æ”¹ç”¨ `visibility` ã€‚ä½†ç›´æ¥ä½¿ç”¨ `visibility` ä¹Ÿæ˜¯æ— æ³•å®ç°åŠ¨ç”»æ•ˆæœï¼Œç»“åˆ `opacity` åæ‰å®ç°ã€‚

ã€€ã€€å¥½äº†ï¼Œå¤§è‡´å®ç°è¿‡ç¨‹ä»‹ç»å®Œäº†ï¼Œåšäº†ä¸€ä¸ª demo ï¼Œé“¾æ¥å¦‚ä¸‹ï¼š

> [å›¾ç‰‡ç€‘å¸ƒæµ DEMO]

ã€€ã€€ä»£ç åœ¨ Github åœ°å€å¦‚ä¸‹ï¼š

> [Waterfall]

[å›¾ç‰‡ç€‘å¸ƒæµ demo]: /demos/waterfall
[Waterfall]: https://github.com/bruce-xu/waterfall
